<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Content Grid</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Header / Toolbar -->
  <header class="toolbar">
    <div class="toolbar-left">
      <h1 class="title">Posts <span id="count" class="count"></span></h1>
    </div>
    <div class="toolbar-right">
      <button id="btnRefresh" class="btn" type="button">Refresh</button>
      <input id="txtSearch" class="search" type="search" placeholder="Buscar..." aria-label="Search posts" />
    </div>
  </header>

  <!-- Filtros -->
  <section class="filters">
    <div class="filters-row">
      <select id="selClient" class="filter" aria-label="Client">
        <option value="">All Clients</option>
      </select>
      <select id="selProject" class="filter" aria-label="Project">
        <option value="">All Projects</option>
      </select>
      <select id="selBrand" class="filter" aria-label="Brand" disabled>
        <option value="">All Brands</option>
      </select>
      <select id="selPlatform" class="filter" aria-label="Platform">
        <option value="all">All Platforms</option>
        <option value="Instagram">Instagram</option>
        <option value="Tiktok">Tiktok</option>
        <option value="Youtube">Youtube</option>
        <option value="Facebook">Facebook</option>
        <option value="Página web">Página web</option>
        <option value="Pantalla">Pantalla</option>
      </select>
      <select id="selStatus" class="filter" aria-label="Status">
        <option value="published">Published Only</option>
        <option value="all">All Status</option>
      </select>
    </div>

    <div id="chips" class="chips"></div>
  </section>

  <!-- Grid -->
  <main>
    <div id="grid" class="grid"></div>
    <div class="loadmore-wrap">
      <button id="btnMore" class="btn" type="button" style="display:none;">Load more</button>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" hidden>
    <div class="modal-content">
      <button id="modalClose" class="btn btn-ghost" aria-label="Close">×</button>
      <div class="modal-header"><h2 id="modalTitle"></h2></div>
      <div class="modal-body">
        <img id="modalImg" class="modal-media" alt="" />
        <video id="modalVid" class="modal-media" controls playsinline hidden></video>
      </div>
      <div id="modalCopy" class="modal-copy"></div>
      <div class="modal-footer">
        <div class="modal-indicators" id="modalDots"></div>
      </div>
    </div>
  </div>

<script>
let STATE = {
  q: '',
  status: 'published',
  client: '',
  project: '',
  brand: '',
  platform: 'all',
  limit: 12,
  cursor: null,
  posts: [],
  loading: false
};

const selClient   = document.getElementById('selClient');
const selProject  = document.getElementById('selProject');
const selBrand    = document.getElementById('selBrand');
const selPlatform = document.getElementById('selPlatform');
const selStatus   = document.getElementById('selStatus');
const txtSearch   = document.getElementById('txtSearch');
const btnRefresh  = document.getElementById('btnRefresh');
const btnMore     = document.getElementById('btnMore');
const chips       = document.getElementById('chips');
const grid        = document.getElementById('grid');
const countEl     = document.getElementById('count');

const modal       = document.getElementById('modal');
const modalClose  = document.getElementById('modalClose');
const modalTitle  = document.getElementById('modalTitle');
const modalImg    = document.getElementById('modalImg');
const modalVid    = document.getElementById('modalVid');
const modalCopy   = document.getElementById('modalCopy');
const modalDots   = document.getElementById('modalDots');

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function debounce(fn,ms=250){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function uniq(arr){return [...new Set(arr.filter(Boolean))];}

async function fetchPosts({reset=false} = {}) {
  if (STATE.loading) return;
  STATE.loading = true;

  try {
    const qs = new URLSearchParams();
    qs.set('limit', STATE.limit);
    if (STATE.cursor) qs.set('cursor', STATE.cursor);
    if (STATE.q) qs.set('q', STATE.q);
    if (STATE.client) qs.set('client', STATE.client);
    if (STATE.project) qs.set('project', STATE.project);
    if (STATE.brand) qs.set('brand', STATE.brand);
    if (STATE.platform && STATE.platform !== 'all') qs.set('platform', STATE.platform);
    qs.set('status', STATE.status);

    const r = await fetch('/api/grid?' + qs.toString());
    const data = await r.json();

    if (!r.ok || !data.ok) {
      throw new Error(data.error || 'API error');
    }

    const newPosts = data.posts || [];
    if (reset) {
      STATE.posts = newPosts;
    } else {
      STATE.posts = STATE.posts.concat(newPosts);
    }
    STATE.cursor = data.next_cursor || null;

    buildOptionsFromPosts(STATE.posts);
    renderGrid();
    renderChips();
  } catch (err) {
    grid.innerHTML = `<div class="error">Error: ${escapeHtml(err.message)}</div>`;
  } finally {
    STATE.loading = false;
  }
}

function buildOptionsFromPosts(posts) {
  const clients = uniq(posts.map(p => p.client)).sort();
  selClient.innerHTML = '<option value="">All Clients</option>' + clients.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  selClient.value = STATE.client;

  const projects = uniq(posts.map(p => p.project)).sort();
  selProject.innerHTML = '<option value="">All Projects</option>' + projects.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
  selProject.value = STATE.project;

  syncBrandSelect();
}
function syncBrandSelect() {
  if (!STATE.client) {
    selBrand.disabled = true;
    selBrand.innerHTML = '<option value="">All Brands</option>';
    selBrand.value = '';
    return;
  }
  const brands = uniq(STATE.posts.filter(p => p.client === STATE.client).map(p => p.brand)).sort();
  selBrand.disabled = false;
  selBrand.innerHTML = '<option value="">All Brands</option>' + brands.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
  if (brands.length === 1) {
    STATE.brand = brands[0];
  }
  selBrand.value = STATE.brand || '';
}

function renderChips() {
  const parts = [];
  if (STATE.client)   parts.push(chip('Client', STATE.client,  ()=>{ STATE.client=''; STATE.brand=''; selClient.value=''; syncBrandSelect(); reload(); }));
  if (STATE.project)  parts.push(chip('Project',STATE.project, ()=>{ STATE.project=''; selProject.value=''; reload(); }));
  if (STATE.brand)    parts.push(chip('Brand',  STATE.brand,   ()=>{ STATE.brand=''; selBrand.value=''; reload(); }));
  if (STATE.platform && STATE.platform!=='all') parts.push(chip('Platform', STATE.platform, ()=>{ STATE.platform='all'; selPlatform.value='all'; reload(); }));
  if (STATE.status && STATE.status!=='published') parts.push(chip('Status', 'All', ()=>{ STATE.status='published'; selStatus.value='published'; reload(); }));
  if (STATE.q) parts.push(chip('q', STATE.q, ()=>{ STATE.q=''; txtSearch.value=''; reload(); }));

  chips.innerHTML = parts.join('') + (parts.length ? `<button class="btn btn-ghost" id="clearAll" type="button">Clear all</button>` : '');
  const clearBtn = document.getElementById('clearAll');
  if (clearBtn) clearBtn.onclick = () => {
    STATE = { ...STATE, q:'', status:'published', client:'', project:'', brand:'', platform:'all', cursor:null, posts:[] };
    selClient.value = ''; selProject.value=''; selBrand.value=''; selBrand.disabled=true; selPlatform.value='all'; selStatus.value='published'; txtSearch.value='';
    fetchPosts({reset:true});
  };
}
function chip(label, value, onRemove) {
  const id = 'chip_' + Math.random().toString(36).slice(2);
  queueMicrotask(()=>{ const el = document.getElementById(id); if (el) el.onclick = onRemove; });
  return `<span class="chip">${escapeHtml(label)}: ${escapeHtml(value)} <button id="${id}" class="chip-x" type="button" aria-label="Remove">×</button></span>`;
}

function renderGrid() {
  const total = STATE.posts.length;
  countEl.textContent = total ? `(${total})` : '';

  grid.innerHTML = '';
  if (!total) {
    grid.innerHTML = `<div class="empty">No results</div>`;
    btnMore.style.display = 'none';
    return;
  }

  STATE.posts.forEach(post => grid.appendChild(card(post)));
  btnMore.style.display = STATE.cursor ? 'inline-flex' : 'none';
}

function card(post) {
  const el = document.createElement('button');
  el.className = 'card';
  el.type = 'button';
  el.setAttribute('aria-label', post.title || 'post');

  const a = (post.assets && post.assets[0]) || null;

  if (a && a.type === 'video') {
    el.innerHTML = `
      <div class="media-wrap">
        <video class="media" src="${encodeURI(a.url)}" playsinline muted></video>
        <span class="badge badge-video">▶</span>
        ${post.assets && post.assets.length>1 ? '<span class="badge badge-carousel">IG</span>' : ''}
      </div>
      <div class="overlay">
        <div class="ovl-title">${escapeHtml(post.title || '')}</div>
        <div class="ovl-meta">${escapeHtml(post.client || '')}${post.project ? ' · '+escapeHtml(post.project) : ''}${post.date ? ' · '+escapeHtml(post.date) : ''}</div>
      </div>
    `;
    el.addEventListener('mouseenter', ()=>{ const v = el.querySelector('video'); v && v.play(); });
    el.addEventListener('mouseleave', ()=>{ const v = el.querySelector('video'); v && v.pause(); });
  } else if (a && a.type === 'image') {
    el.innerHTML = `
      <div class="media-wrap">
        <img class="media" src="${encodeURI(a.url)}" alt="${escapeHtml(post.title || '')}" />
        ${post.assets && post.assets.length>1 ? '<span class="badge badge-carousel">IG</span>' : ''}
      </div>
      <div class="overlay">
        <div class="ovl-title">${escapeHtml(post.title || '')}</div>
        <div class="ovl-meta">${escapeHtml(post.client || '')}${post.project ? ' · '+escapeHtml(post.project) : ''}${post.date ? ' · '+escapeHtml(post.date) : ''}</div>
      </div>
    `;
  } else {
    el.innerHTML = `<div class="media-wrap placeholder">No image</div>`;
  }

  el.onclick = () => openModal(post);
  return el;
}

function openModal(post) {
  const a = (post.assets && post.assets[0]) || null;
  modalTitle.textContent = post.title || '';

  if (a && a.type === 'video') {
    modalVid.src = a.url;
    modalVid.hidden = false;
    modalImg.hidden = true;
    modalVid.play().catch(()=>{});
  } else {
    modalImg.src = a ? a.url : '';
    modalImg.hidden = false;
    modalVid.hidden = true;
    modalVid.pause();
  }

  if (post.copy) {
    modalCopy.textContent = post.copy;
    modalCopy.style.display = 'block';
  } else {
    modalCopy.style.display = 'none';
  }

  modalDots.innerHTML = (post.assets && post.assets.length>1)
    ? Array.from({length: post.assets.length}, (_,i)=>`<span class="dot ${i===0?'active':''}"></span>`).join('')
    : '';

  modal.hidden = false;
}
function closeModal() {
  modal.hidden = true;
  modalVid.pause(); modalVid.currentTime = 0;
}
modalClose.onclick = closeModal;
modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.hidden) closeModal(); });

btnRefresh.onclick = ()=> reload(true);
btnMore.onclick    = ()=> loadMore();

selClient.onchange   = ()=>{ STATE.client = selClient.value; STATE.brand=''; syncBrandSelect(); reload(); };
selProject.onchange  = ()=>{ STATE.project = selProject.value; reload(); };
selBrand.onchange    = ()=>{ STATE.brand = selBrand.value; reload(); };
selPlatform.onchange = ()=>{ STATE.platform = selPlatform.value; reload(); };
selStatus.onchange   = ()=>{ STATE.status = selStatus.value; reload(true); };

txtSearch.addEventListener('input', debounce(()=>{
  STATE.q = (txtSearch.value || '').trim();
  reload(true);
}, 250));

function reload(hard=false) {
  STATE.cursor = null;
  if (hard) STATE.posts = [];
  fetchPosts({reset:true});
}
function loadMore() {
  if (!STATE.cursor) return;
  fetchPosts({reset:false});
}

(async function init(){
  await fetchPosts({reset:true});
})();
</script>
</body>
</html>
