<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posts</title>
  <!-- Usa tus estilos base del widget (Flujo Creativo). No añadimos CSS nuevo. -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Header -->
  <header class="toolbar">
    <div class="toolbar-left">
      <h1 class="title">Posts <span id="count" class="count"></span></h1>
    </div>
    <div class="toolbar-right">
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>
  </header>

  <!-- Filtros -->
  <section class="filters">
    <div class="filters-row">
      <select id="selProject" aria-label="Project">
        <option value="">All Projects</option>
      </select>

      <select id="selClient" aria-label="Client">
        <option value="">All Clients</option>
      </select>

      <select id="selBrand" aria-label="Brand" disabled>
        <option value="">All Brands</option>
      </select>

      <label class="toggle">
        <input type="checkbox" id="chkDraft" />
        <span>Draft only</span>
      </label>
    </div>

    <div class="filters-row">
      <input id="txtSearch" type="search" placeholder="Buscar posts..." />
    </div>

    <div id="chips" class="chips"></div>
  </section>

  <!-- Grid -->
  <main>
    <div id="grid" class="grid"></div>
    <div class="loadmore-wrap">
      <button id="btnMore" class="btn" style="display:none;">Load more</button>
    </div>
  </main>

  <!-- Modal simple -->
  <div id="modal" class="modal" hidden>
    <div class="modal-content">
      <button id="modalClose" class="btn btn-ghost" aria-label="Close">×</button>
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
      </div>
      <div class="modal-body">
        <img id="modalImg" alt="" />
        <video id="modalVid" controls playsinline muted hidden></video>
      </div>
    </div>
  </div>

<script>
/* -------------------- Estado -------------------- */
let ALL = [];           // posts del backend
let FILTERED = [];      // posts filtrados
let PAGE = 1;
const PAGE_SIZE = 24;

/* -------------------- DOM -------------------- */
const selProject = document.getElementById('selProject');
const selClient  = document.getElementById('selClient');
const selBrand   = document.getElementById('selBrand');
const chkDraft   = document.getElementById('chkDraft');
const txtSearch  = document.getElementById('txtSearch');
const chips      = document.getElementById('chips');
const grid       = document.getElementById('grid');
const countEl    = document.getElementById('count');
const btnMore    = document.getElementById('btnMore');
const btnRefresh = document.getElementById('btnRefresh');

const modal      = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');
const modalTitle = document.getElementById('modalTitle');
const modalImg   = document.getElementById('modalImg');
const modalVid   = document.getElementById('modalVid');

/* -------------------- Utils -------------------- */
function debounce(fn, ms = 250) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}
function uniq(arr) { return [...new Set(arr.filter(Boolean))]; }

/* -------------------- Fetch -------------------- */
async function fetchPosts() {
  const draft = chkDraft.checked ? '1' : '';
  const q     = txtSearch.value.trim();
  const qs    = new URLSearchParams();
  if (draft) qs.set('draft', '1');
  if (q)     qs.set('q', q);

  const url = '/api/grid' + (qs.toString() ? `?${qs}` : '');
  const r = await fetch(url);
  if (!r.ok) throw new Error('Error leyendo /api/grid');
  const data = await r.json();
  ALL = (data.posts || []).map(p => ({
    ...p,
    client: p.client || "",
    brands: Array.isArray(p.brands) ? p.brands : []
  }));
}

function buildOptions() {
  // Projects
  const proj = uniq(ALL.map(p => p.project));
  selProject.innerHTML = '<option value="">All Projects</option>' +
    proj.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');

  // Clients
  const clients = uniq(ALL.map(p => p.client));
  selClient.innerHTML = '<option value="">All Clients</option>' +
    clients.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('');

  // Brand depende de client -> se recalcula en onClientChange
  selBrand.disabled = !selClient.value;
  selBrand.innerHTML = '<option value="">All Brands</option>';
}

function onClientChange() {
  const c = selClient.value.trim();
  if (!c) {
    selBrand.disabled = true;
    selBrand.innerHTML = '<option value="">All Brands</option>';
    return;
  }
  const brands = uniq(ALL.filter(p => p.client === c).flatMap(p => p.brands));
  selBrand.disabled = false;
  selBrand.innerHTML = '<option value="">All Brands</option>' +
    brands.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
  // Autoselect si hay una sola marca
  if (brands.length === 1) selBrand.value = brands[0];
}

function currentFilters() {
  return {
    project: selProject.value.trim(),
    client:  selClient.value.trim(),
    brand:   selBrand.value.trim(),
    q:       txtSearch.value.trim().toLowerCase(),
    draft:   chkDraft.checked
  };
}

function applyFilters() {
  const f = currentFilters();
  let arr = [...ALL];

  if (f.project) arr = arr.filter(p => p.project === f.project);
  if (f.client)  arr = arr.filter(p => p.client  === f.client);
  if (f.brand)   arr = arr.filter(p => (p.brands || []).includes(f.brand));
  if (f.q)       arr = arr.filter(p => (p.title || "").toLowerCase().includes(f.q));

  FILTERED = arr;
  PAGE = 1;
  renderChips();
  renderGrid();
}

function renderChips() {
  const f = currentFilters();
  const parts = [];
  if (f.project) parts.push(chip('Project', f.project, () => { selProject.value = ""; applyFilters(); }));
  if (f.client)  parts.push(chip('Client',  f.client,  () => { selClient.value = ""; selBrand.value = ""; onClientChange(); applyFilters(); }));
  if (f.brand)   parts.push(chip('Brand',   f.brand,   () => { selBrand.value = ""; applyFilters(); }));
  if (f.q)       parts.push(chip('q',       f.q,       () => { txtSearch.value = ""; applyFilters(); }));
  chips.innerHTML = parts.join('') + (parts.length ? `<button class="btn btn-ghost" id="clearAll">Clear all</button>` : '');
  const clearBtn = document.getElementById('clearAll');
  if (clearBtn) clearBtn.onclick = () => {
    selProject.value = ""; selClient.value = ""; selBrand.value = ""; onClientChange(); txtSearch.value = "";
    applyFilters();
  };
}

function chip(label, value, onRemove) {
  const id = 'chip_' + Math.random().toString(36).slice(2);
  queueMicrotask(() => {
    const x = document.getElementById(id);
    if (x) x.onclick = onRemove;
  });
  return `<span class="chip">${escapeHtml(label)}: ${escapeHtml(value)} <button id="${id}" class="chip-x" aria-label="Remove">×</button></span>`;
}

function renderGrid() {
  const total = FILTERED.length;
  countEl.textContent = total ? `(${total})` : '';

  grid.innerHTML = '';
  const upto = PAGE * PAGE_SIZE;
  const slice = FILTERED.slice(0, upto);

  if (!slice.length) {
    grid.innerHTML = `<div class="empty">No results</div>`;
    btnMore.style.display = 'none';
    return;
    }

  slice.forEach(post => grid.appendChild(card(post)));

  btnMore.style.display = (upto < total) ? 'inline-flex' : 'none';
}

function card(post) {
  const el = document.createElement('button');
  el.className = 'card';
  el.setAttribute('type', 'button');
  el.setAttribute('aria-label', post.title || 'post');

  const main = (post.assets && post.assets[0]) || null;

  if (main && main.type === 'video') {
    el.innerHTML = `
      <div class="media-wrap">
        <video class="media" src="${encodeURI(main.url)}" playsinline muted></video>
        <span class="badge badge-video">▶</span>
      </div>
      <div class="overlay">
        <div class="ovl-title">${escapeHtml(post.title || '')}</div>
        <div class="ovl-meta">${escapeHtml(post.client || '')}${post.project ? ' · ' + escapeHtml(post.project) : ''}${post.date ? ' · ' + escapeHtml(post.date) : ''}</div>
      </div>
    `;
    el.addEventListener('mouseenter', () => { const v = el.querySelector('video'); v && v.play(); });
    el.addEventListener('mouseleave', () => { const v = el.querySelector('video'); v && v.pause(); });
  } else if (main && main.type === 'image') {
    el.innerHTML = `
      <div class="media-wrap">
        <img class="media" src="${encodeURI(main.url)}" alt="${escapeHtml(post.title || '')}" />
      </div>
      <div class="overlay">
        <div class="ovl-title">${escapeHtml(post.title || '')}</div>
        <div class="ovl-meta">${escapeHtml(post.client || '')}${post.project ? ' · ' + escapeHtml(post.project) : ''}${post.date ? ' · ' + escapeHtml(post.date) : ''}</div>
      </div>
    `;
  } else {
    el.innerHTML = `<div class="media-wrap placeholder">No image</div>`;
  }

  el.onclick = () => openModal(post);

  return el;
}

/* -------------------- Modal -------------------- */
function openModal(post) {
  const a = (post.assets && post.assets[0]) || null;
  modalTitle.textContent = post.title || '';
  if (a && a.type === 'video') {
    modalVid.src = a.url;
    modalVid.hidden = false;
    modalImg.hidden = true;
    modalVid.play().catch(()=>{});
  } else {
    modalImg.src = a ? a.url : '';
    modalImg.hidden = false;
    modalVid.hidden = true;
    modalVid.pause();
  }
  modal.hidden = false;
}
function closeModal() {
  modal.hidden = true;
  modalVid.pause(); modalVid.currentTime = 0;
}
modalClose.onclick = closeModal;
modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.hidden) closeModal(); });

/* -------------------- Wire-up -------------------- */
btnRefresh.onclick = async () => { await bootstrap(); };
btnMore.onclick = () => { PAGE += 1; renderGrid(); };

selClient.addEventListener('change', () => { onClientChange(); applyFilters(); });
selProject.addEventListener('change', applyFilters);
selBrand.addEventListener('change', applyFilters);
chkDraft.addEventListener('change', async () => { await bootstrap(); }); // draft cambia el fetch
txtSearch.addEventListener('input', debounce(applyFilters, 250));

function escapeHtml(s) {
  return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

async function bootstrap() {
  await fetchPosts();
  buildOptions();
  onClientChange(); // setea brands según client (si hubiera seleccionado antes)
  applyFilters();
}

bootstrap().catch(err => {
  grid.innerHTML = `<div class="error">Error: ${escapeHtml(err.message)}</div>`;
});
</script>
</body>
</html>
