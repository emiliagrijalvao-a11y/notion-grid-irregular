<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Grid</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #fafafa;
      color: #333;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h1 { font-size: 24px; font-weight: 600; }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    select, input[type="text"], button {
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background: #f5f5f5;
      border: 1px solid #ccc;
    }
    button:hover { background: #e8e8e8; }
    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .chip {
      background: #e0e0e0;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      line-height: 1;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .card-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      background: #f0f0f0;
    }
    .card-body {
      padding: 12px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .badge {
      display: inline-block;
      background: #fff3cd;
      color: #856404;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 6px;
    }
    .pin-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 16px;
    }
    .load-more {
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Posts</h1>
      <span id="count">0 resultados</span>
    </div>

    <div class="controls">
      <select id="projectSelect">
        <option value="">Project: todos</option>
      </select>
      <select id="clientSelect">
        <option value="">Client: todos</option>
      </select>
      <select id="brandSelect" disabled>
        <option value="">Brand: todos</option>
      </select>
      <input id="search" type="text" placeholder="Buscar posts...">
      <label><input id="draftOnly" type="checkbox"> Draft only</label>
      <button id="refresh">Refresh</button>
      <button id="clearAll">Clear all</button>
    </div>

    <div id="chips" class="chips"></div>
    
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" hidden>No hay resultados con los filtros actuales.</div>
    
    <div class="load-more">
      <button id="loadMore">Load more</button>
    </div>
  </div>

  <script>
    const state = {
      all: [],
      project: "",
      client: "",
      brand: "",
      q: "",
      draft: false,
      page: 1,
      pageSize: 24
    };

    const els = {
      project: document.getElementById("projectSelect"),
      client: document.getElementById("clientSelect"),
      brand: document.getElementById("brandSelect"),
      search: document.getElementById("search"),
      draft: document.getElementById("draftOnly"),
      refresh: document.getElementById("refresh"),
      clearAll: document.getElementById("clearAll"),
      chips: document.getElementById("chips"),
      grid: document.getElementById("grid"),
      empty: document.getElementById("empty"),
      count: document.getElementById("count"),
      loadMore: document.getElementById("loadMore")
    };

    function debounce(fn, ms) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    async function load() {
      const params = new URLSearchParams({
        q: state.q,
        project: state.project,
        client: state.client,
        brand: state.brand,
        draft: state.draft ? "1" : ""
      });
      const res = await fetch(`/api/grid?${params}`);
      const json = await res.json();
      state.all = json.items || [];
      render();
    }

    function render() {
      const items = state.all;
      els.count.textContent = `${items.length} resultados`;
      els.empty.hidden = items.length > 0;

      const slice = items.slice(0, state.page * state.pageSize);
      els.loadMore.style.display = slice.length < items.length ? "block" : "none";

      els.grid.innerHTML = slice.map(item => `
        <div class="card">
          ${item.pinned ? '<div class="pin-icon">ðŸ“Œ</div>' : ''}
          ${item.assets[0] ? `<img class="card-image" src="${item.assets[0].url}" alt="">` : '<div class="card-image"></div>'}
          <div class="card-body">
            <div class="card-title">
              ${item.title}
              ${item.isDraft ? '<span class="badge">Draft</span>' : ''}
            </div>
          </div>
        </div>
      `).join("");

      renderChips();
    }

    function renderChips() {
      const chips = [];
      if (state.project) chips.push({ label: "Project", value: els.project.selectedOptions[0]?.text, clear: () => { state.project = ""; els.project.value = ""; } });
      if (state.client) chips.push({ label: "Client", value: els.client.selectedOptions[0]?.text, clear: () => { state.client = ""; state.brand = ""; els.client.value = ""; els.brand.value = ""; } });
      if (state.brand) chips.push({ label: "Brand", value: els.brand.selectedOptions[0]?.text, clear: () => { state.brand = ""; els.brand.value = ""; } });
      if (state.q) chips.push({ label: "BÃºsqueda", value: state.q, clear: () => { state.q = ""; els.search.value = ""; } });

      els.chips.innerHTML = chips.map((c, i) => `
        <div class="chip">
          <strong>${c.label}:</strong> ${c.value}
          <button data-idx="${i}">Ã—</button>
        </div>
      `).join("");

      els.chips.querySelectorAll("button").forEach((btn, i) => {
        btn.onclick = () => {
          chips[i].clear();
          state.page = 1;
          load();
        };
      });
    }

    els.project.onchange = () => { state.project = els.project.value; state.page = 1; load(); };
    els.client.onchange = () => { state.client = els.client.value; state.brand = ""; els.brand.value = ""; state.page = 1; load(); };
    els.brand.onchange = () => { state.brand = els.brand.value; state.page = 1; load(); };
    els.draft.onchange = () => { state.draft = els.draft.checked; state.page = 1; load(); };
    els.search.addEventListener("input", debounce(() => { state.q = els.search.value.trim(); state.page = 1; load(); }, 250));
    els.clearAll.onclick = () => {
      state.project = state.client = state.brand = state.q = "";
      state.draft = false;
      state.page = 1;
      els.project.value = els.client.value = els.brand.value = els.search.value = "";
      els.draft.checked = false;
      load();
    };
    els.loadMore.onclick = () => { state.page++; render(); };
    els.refresh.onclick = () => load();

    load();
  </script>
</body>
</html>
